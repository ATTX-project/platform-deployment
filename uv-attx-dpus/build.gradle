apply plugin: 'de.undercouch.download'
apply plugin: "com.chrisgahlert.gradle-dcompose-plugin"

ext {
    Image_version = "latest"
    MetadataPlugin_version = "1.0-SNAPSHOT"
    Infras2IPlugin_version = "1.0-SNAPSHOT"
    UploaderPlugin_version = "1.0-SNAPSHOT"
}

import de.undercouch.gradle.tasks.download.Download
task downloadJars(type:Download) {
    // TODO: Change this to use artifact repository
    src([
        "${jenkinsArtifactRepoURL}/job/uv-dpu-t-attx-metadata/lastSuccessfulBuild/artifact/unifiedViews/uv-dpu-t-attx-metadata/target/uv-dpu-t-attx-metadata-${MetadataPlugin_version}.jar",
        "${jenkinsArtifactRepoURL}/job/uv-dpu-t-attx-uc1-infras2internal/lastSuccessfulBuild/artifact/unifiedViews/uv-dpu-t-attx-uc1-infras2internal/build/libs/Infras2Internal-${Infras2IPlugin_version}.jar",
        "${jenkinsArtifactRepoURL}/job/uv-dpu-l-attx-uploader/lastSuccessfulBuild/artifact/unifiedViews/uv-dpu-l-attx-uploader/target/uv-dpu-l-attx-uploader-${UploaderPlugin_version}.jar"
    ])
    dest "$projectDir/dpus/"
}

task dockerPrepare () {
    doLast {
        mkdir "$projectDir/dpus"
        tasks.downloadJars.execute()
    }
}

dcompose {
	registry ("$registryURL") {
     	 // Needs no user/pass
 	}
	uvattxdpus {
		baseDir = file('.')
		dockerFilename = 'Dockerfile'
    repository = "${imageRepo}:${imageRepoPort}/uv-attx-dpus:${Image_version}"
	}
}

buildUvattxdpusImage.dependsOn dockerPrepare
pushUvattxdpusImage.dependsOn dockerPrepare
