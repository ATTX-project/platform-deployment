plugins {
    id 'com.palantir.docker' version '0.9.2'
    id 'base'
}

apply plugin: 'de.undercouch.download'

if (!project.hasProperty("artifactRepoUrl")) {
    ext.artifactRepoUrl = "http://attx-dev.hulib.helsinki.fi:8081/repository/attx-releases"
}
if (!project.hasProperty("artifactRepoUser")) {
    ext.artifactRepoUser = "jenkins"
}
if (!project.hasProperty("artifactRepoPassword")) {
    ext.artifactRepoPassword = "jeppaa1"
}
if (!project.hasProperty("registryUrl")) {
    ext.registryUrl = "http://attx-dev.hulib.helsinki.fi:5000"
}


version=0.1

import de.undercouch.gradle.tasks.download.Download
task downloadJars(type:Download) {
    // TODO: Change this to use artifact repository
    src "${artifactRepoUrl}/job/wf-api/lastSuccessfulBuild/artifact/wf-API/build/distributions/wf-API-${version}.tar.gz"
    dest "$buildDir/docker/build/distributions/wf-API-${version}.tar.gz"

}

dockerPrepare.doLast {
    mkdir "$buildDir/docker/build/distributions"
    tasks.downloadJars.execute()
}


docker {
    name "${registryUrl}/wf-api"
    tags 'latest'
    dockerfile 'Dockerfile'
    files 'Dockerfile'
}
