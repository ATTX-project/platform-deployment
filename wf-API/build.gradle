plugins {
    id "de.undercouch.download" version "3.1.2"
    // id "com.chrisgahlert.gradle-dcompose-plugin" version "0.8.2"
}

apply plugin: "com.chrisgahlert.gradle-dcompose-plugin"

version=0.1

repositories {
    mavenCentral()
}

import de.undercouch.gradle.tasks.download.Download
task downloadJars(type:Download) {
    // TODO: Change this to use artifact repository
    src "${artifactRepoUrl}/job/wf-api/lastSuccessfulBuild/artifact/wf-API/build/distributions/wf-API-${version}.tar.gz"
    dest "$projectDir/build/distributions/wf-API-${version}.tar.gz"
}

task dockerPrepare () {
  doLast {
    mkdir "$projectDir/build/distributions"
    tasks.downloadJars.execute()
  }
}

dcompose {
	registry ('http://attx-dev:5000') {
     	 // Needs no user/pass
 	 }
	wfapi {
		baseDir = file('.')
		dockerFilename = 'Dockerfile'
    		repository = 'attx-dev:5000/wf-api:latest'
	}
}

buildWfapiImage.dependsOn dockerPrepare
pushWfapiImage.dependsOn dockerPrepare
