apply plugin: 'de.undercouch.download'
apply plugin: "com.chrisgahlert.gradle-dcompose-plugin"

ext {
    WFAPI_version = "0.1"
    Image_version = "latest"
}

import de.undercouch.gradle.tasks.download.Download
task downloadJars(type:Download) {
    // TODO: Change this to use artifact repository
    src "${jenkinsArtifactRepoURL}/job/wf-api/lastSuccessfulBuild/artifact/wf-API/build/distributions/wf-API-${WFAPI_version}.tar.gz"
    dest "$projectDir/build/distributions/wf-API-${WFAPI_version}.tar.gz"
}

task dockerPrepare () {
    doLast {
        mkdir "$projectDir/build/distributions"
        tasks.downloadJars.execute()
    }
}

dcompose {
	registry ("$registryURL") {
     	 // Needs no user/pass
 	}
	wfapi {
		baseDir = file('.')
		dockerFilename = 'Dockerfile'
        repository = "${imageRepo}:${imageRepoPort}/wf-api:${Image_version}"
	}
}

buildWfapiImage.dependsOn dockerPrepare
pushWfapiImage.dependsOn dockerPrepare
