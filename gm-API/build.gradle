apply plugin: 'com.chrisgahlert.gradle-dcompose-plugin'
apply plugin: 'de.undercouch.download'

import de.undercouch.gradle.tasks.download.Download
task downloadJars(type:Download) {
    // TODO: Change this to use artifact repository
    src([
        "${artifactRepoURL}/org/uh/hulib/attx/gc/gm-API/${gmAPI}/gm-API-${gmAPI}.tar.gz",
        "${artifactRepoURL}/org/uh/hulib/attx/gc/gc-rdf2json-indexer-all/${rdfINDEXER}/gc-rdf2json-indexer-all-${rdfINDEXER}-all.jar"
    ])
    dest "$projectDir/build/distributions/"
}

task dockerPrepare () {
  doLast {
    mkdir "$projectDir/build/distributions"
    tasks.downloadJars.execute()
  }
}

dcompose {
  registry ("$registryURL") {
     	 // Needs no user/pass
 	 }
  gmapi {
    baseDir = file('.')
    repository = "${imageRepo}:${imageRepoPort}/gm-api:${imageGM}"
    portBindings = ['4302:4302']
    env = ["GMAPI=$gmAPI", "RDFINDEXER=$rdfINDEXER"]
    buildArgs = ["GMAPI":"$gmAPI", "RDFINDEXER":"$rdfINDEXER"]
  }
}

buildGmapiImage.dependsOn dockerPrepare
pushGmapiImage.dependsOn dockerPrepare
